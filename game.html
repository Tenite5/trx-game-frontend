<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRX Voronoi Hex - Game</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .game-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            padding: 30px;
            text-align: center;
            max-width: 800px;
            width: 95%;
            max-height: 95vh;
            overflow-y: auto;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2.2em;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #007bff;
            flex-wrap: wrap;
            gap: 10px;
        }

        .player-info {
            flex: 1;
            min-width: 150px;
        }

        .player-info h3 {
            margin: 0 0 5px 0;
            font-size: 1.1em;
            color: #333;
        }

        .player-info p {
            margin: 3px 0;
            font-size: 0.9em;
            color: #666;
        }

        .game-stats {
            text-align: center;
            flex: 1;
            min-width: 120px;
        }

        .game-stats p {
            margin: 3px 0;
            font-weight: 600;
            color: #007bff;
        }

        .turn-indicator {
            font-size: 18px;
            font-weight: bold;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .your-turn {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border: 2px solid #28a745;
            animation: pulse 2s infinite;
        }

        .opponent-turn {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            color: #856404;
            border: 2px solid #ffc107;
        }

        .game-over-indicator {
            background: linear-gradient(135deg, #e2e3e5, #d6d8db);
            color: #383d41;
            border: 2px solid #6c757d;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .timer-display {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #007bff;
        }

        .timer-text {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .timer-bar-container {
            width: 100%;
            height: 12px;
            background: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .timer-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #ffc107, #dc3545);
            transition: width 0.1s linear;
            border-radius: 6px;
        }

        .side-indicators {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            font-weight: bold;
            font-size: 16px;
        }

        .player1-goal {
            color: #e74c3c;
            padding: 8px 12px;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .player2-goal {
            color: #3498db;
            padding: 8px 12px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(52, 152, 219, 0.3);
        }

        .game-board {
            position: relative;
            width: 500px;
            height: 500px;
            margin: 20px auto;
            border: 3px solid #333;
            border-radius: 15px;
            background: #ffffff;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.1);
        }

        .voronoi-cell {
            cursor: pointer;
            transition: all 0.2s ease;
            stroke: #333;
            stroke-width: 2;
            fill: #f8f9fa;
        }

        .voronoi-cell:hover:not(.claimed):not(.disabled) {
            fill: #e9ecef;
            stroke-width: 3;
            filter: drop-shadow(0 0 5px rgba(0, 123, 255, 0.3));
        }

        .voronoi-cell.player1 {
            fill: #e74c3c;
            opacity: 0.85;
            stroke: #c0392b;
        }

        .voronoi-cell.player2 {
            fill: #3498db;
            opacity: 0.85;
            stroke: #2980b9;
        }

        .voronoi-cell.disabled {
            cursor: not-allowed;
        }

        .voronoi-cell.your-symbol:hover:not(.claimed) {
            fill: rgba(40, 167, 69, 0.2);
        }

        .edge-indicator {
            opacity: 0.6;
            pointer-events: none;
        }

        .status-message {
            margin: 20px 0;
            font-size: 18px;
            font-weight: 600;
            padding: 15px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .waiting {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            color: #856404;
            border: 2px solid #ffc107;
        }

        .error {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border: 2px solid #dc3545;
        }

        .success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border: 2px solid #28a745;
        }

        .game-result {
            font-size: 24px;
            font-weight: bold;
            margin: 25px 0;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .winner {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border: 3px solid #28a745;
            animation: celebrate 1s ease-in-out;
        }

        .loser {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border: 3px solid #dc3545;
        }

        .draw-result {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            color: #856404;
            border: 3px solid #ffc107;
        }

        @keyframes celebrate {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.05); }
            75% { transform: scale(0.98); }
        }

        .action-buttons {
            margin-top: 25px;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        button:hover:not(:disabled) {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }

        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .refresh-button {
            background: #17a2b8;
        }

        .refresh-button:hover:not(:disabled) {
            background: #138496;
        }

        .forfeit-button {
            background: #dc3545;
        }

        .forfeit-button:hover:not(:disabled) {
            background: #c82333;
        }

        .dashboard-button {
            background: #28a745;
        }

        .dashboard-button:hover:not(:disabled) {
            background: #1e7e34;
        }

        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .connection-hint {
            font-size: 14px;
            color: #666;
            margin: 10px 0;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .game-container {
                padding: 20px;
                margin: 10px;
            }
            
            .game-board {
                width: 350px;
                height: 350px;
            }
            
            .game-header {
                flex-direction: column;
                text-align: center;
            }
            
            .side-indicators {
                flex-direction: column;
                gap: 10px;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            button {
                width: 100%;
                max-width: 250px;
            }
        }

        @media (max-width: 480px) {
            .game-board {
                width: 280px;
                height: 280px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>Voronoi Hex Arena</h1>
        
        <div class="game-header">
            <div class="player-info">
                <h3>Player 1 (Red)</h3>
                <p id="player1-name">Loading...</p>
                <p>Goal: Top ‚Üï Bottom</p>
            </div>
            <div class="game-stats">
                <p>Stake: 10 TRX</p>
                <p>Winner: 19.5 TRX</p>
                <p id="move-count">Moves: 0</p>
            </div>
            <div class="player-info">
                <h3>Player 2 (Blue)</h3>
                <p id="player2-name">Waiting...</p>
                <p>Goal: Left ‚Üî Right</p>
            </div>
        </div>

        <div class="side-indicators">
            <div class="player1-goal">Red: Connect Top to Bottom</div>
            <div class="player2-goal">Blue: Connect Left to Right</div>
        </div>

        <div class="turn-indicator" id="turn-indicator">
            <div class="loading"></div>
            Loading game state...
        </div>

        <div class="timer-display" id="timer-display" style="display: none;">
            <div class="timer-text">
                Time remaining: <span id="timer-countdown">30</span>s
            </div>
            <div class="timer-bar-container">
                <div id="timer-bar" class="timer-bar"></div>
            </div>
        </div>

        <div class="connection-hint">
            <strong>Your color:</strong> <span id="your-color">Loading...</span>
        </div>

        <div class="game-board">
            <svg width="500" height="500" id="game-svg">
                <!-- Voronoi cells will be rendered here -->
            </svg>
        </div>

        <div class="status-message waiting" id="status-message">
            Connecting to game server...
        </div>

        <div class="action-buttons">
            <button id="refresh-button" class="refresh-button" onclick="refreshGame()">
                Refresh Game
            </button>
            <button id="forfeit-button" class="forfeit-button" onclick="showForfeitConfirm()" style="display: none;">
                Forfeit Game
            </button>
            <button class="dashboard-button" onclick="goToDashboard()">
                Back to Dashboard
            </button>
        </div>
    </div>

    <script>
        const API_URL = 'https://trx-game-backend.onrender.com/api';
        const gameId = new URLSearchParams(window.location.search).get('gameId');
        const token = localStorage.getItem('token');
        
        let gameData = {};
        let gameInterval = null;
        let timerInterval = null;
        let voronoiCells = [];

        // Check authentication and game ID
        if (!token || !gameId) {
            alert('Invalid game session. Redirecting to dashboard.');
            window.location.href = 'dashboard.html';
        }

        // Initialize game on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadGame();
            startGamePolling();
        });

        async function loadGame() {
            try {
                const response = await fetch(`${API_URL}/game/${gameId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        alert('Session expired. Please login again.');
                        localStorage.removeItem('token');
                        window.location.href = 'index.html';
                        return;
                    }
                    throw new Error('Failed to load game');
                }
                
                const data = await response.json();
                gameData = data;
                updateGameDisplay();
                
            } catch (error) {
                console.error('Load game error:', error);
                showStatusMessage('Failed to load game. Please refresh the page.', 'error');
            }
        }

        function updateGameDisplay() {
            // Update player information
            document.getElementById('player1-name').textContent = gameData.player1 || 'Loading...';
            document.getElementById('player2-name').textContent = gameData.player2 || 'Waiting for opponent...';
            
            // Update your color display
            const yourColorText = gameData.yourSymbol === 'X' ? 
                'Red (Connect Top ‚Üï Bottom)' : 
                'Blue (Connect Left ‚Üî Right)';
            document.getElementById('your-color').textContent = yourColorText;
            
            // Update move count
            document.getElementById('move-count').textContent = `Moves: ${gameData.moveCount || 0}`;
            
            // Render the game board
            renderVoronoiBoard();
            
            // Update turn indicator and status
            updateTurnIndicator();
            updateGameStatus();
            updateTimer();
            
            // Show forfeit button during active game
            const forfeitButton = document.getElementById('forfeit-button');
            forfeitButton.style.display = gameData.status === 'in_progress' ? 'inline-block' : 'none';
        }

        function renderVoronoiBoard() {
            const svg = document.getElementById('game-svg');
            svg.innerHTML = '';
            
            // Wait for board layout from backend
            if (!gameData.boardLayout || !gameData.boardLayout.cells || gameData.boardLayout.cells.length === 0) {
                console.log('Waiting for board layout from backend...');
                return;
            }
            
            voronoiCells = gameData.boardLayout.cells;
            const edgeCells = gameData.boardLayout.edgeCells || {};
            
            console.log(`Rendering ${voronoiCells.length} cells from backend`);
            
            // Render each Voronoi cell
            voronoiCells.forEach((cell, index) => {
                const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                
                const points = cell.vertices.map(v => `${v.x},${v.y}`).join(' ');
                polygon.setAttribute('points', points);
                polygon.setAttribute('class', 'voronoi-cell');
                polygon.setAttribute('data-cell-id', index);
                
                // Apply player colors based on current game state
                if (gameData.board && gameData.board[index]) {
                    const isPlayer1Cell = gameData.board[index] === 'X';
                    polygon.classList.add(isPlayer1Cell ? 'player1' : 'player2');
                    polygon.classList.add('claimed');
                }
                
                // Disable clicks if not player's turn or game not active
                const isDisabled = !gameData.isYourTurn || 
                                  gameData.status !== 'in_progress' || 
                                  (gameData.board && gameData.board[index] !== '');
                
                if (isDisabled) {
                    polygon.classList.add('disabled');
                } else {
                    // Add visual hint for current player's symbol
                    polygon.classList.add('your-symbol');
                }
                
                // Add click handler for valid moves
                polygon.addEventListener('click', () => {
                    if (!isDisabled) {
                        makeMove(index);
                    }
                });
                
                svg.appendChild(polygon);
            });
            
            // Add edge indicators
            addEdgeIndicators(svg, edgeCells);
        }

        function addEdgeIndicators(svg, edgeCells) {
            // Add subtle indicators for edge cells to help players understand the goals
            const addEdgeMarkers = (cellIndices, color, offsetX, offsetY) => {
                cellIndices.forEach(cellIndex => {
                    const cell = voronoiCells[cellIndex];
                    if (cell && (!gameData.board || !gameData.board[cellIndex])) {
                        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                        circle.setAttribute('cx', cell.center.x + offsetX);
                        circle.setAttribute('cy', cell.center.y + offsetY);
                        circle.setAttribute('r', 4);
                        circle.setAttribute('fill', color);
                        circle.setAttribute('opacity', '0.6');
                        circle.setAttribute('class', 'edge-indicator');
                        svg.appendChild(circle);
                    }
                });
            };
            
            // Red indicators for top/bottom (Player 1 goal)
            if (edgeCells.top) addEdgeMarkers(edgeCells.top, '#e74c3c', 0, -12);
            if (edgeCells.bottom) addEdgeMarkers(edgeCells.bottom, '#e74c3c', 0, 12);
            
            // Blue indicators for left/right (Player 2 goal)
            if (edgeCells.left) addEdgeMarkers(edgeCells.left, '#3498db', -12, 0);
            if (edgeCells.right) addEdgeMarkers(edgeCells.right, '#3498db', 12, 0);
        }

        function updateTurnIndicator() {
            const indicator = document.getElementById('turn-indicator');
            
            if (gameData.status === 'queued') {
                indicator.innerHTML = '<div class="loading"></div>Waiting for opponent to join...';
                indicator.className = 'turn-indicator waiting';
            } else if (gameData.status === 'in_progress') {
                if (gameData.isYourTurn) {
                    const symbolText = gameData.yourSymbol === 'X' ? 'Red' : 'Blue';
                    indicator.innerHTML = `Your Turn! (${symbolText} Player)`;
                    indicator.className = 'turn-indicator your-turn';
                } else {
                    indicator.innerHTML = `${gameData.currentPlayer}'s Turn...`;
                    indicator.className = 'turn-indicator opponent-turn';
                }
            } else if (gameData.status === 'completed') {
                indicator.innerHTML = 'Game Over';
                indicator.className = 'turn-indicator game-over-indicator';
            }
        }

        function updateTimer() {
            const timerDisplay = document.getElementById('timer-display');
            const timerCountdown = document.getElementById('timer-countdown');
            const timerBar = document.getElementById('timer-bar');
            
            // Clear existing timer
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            if (gameData.status === 'in_progress' && gameData.timeRemaining !== null && gameData.timeRemaining !== undefined) {
                timerDisplay.style.display = 'block';
                
                let remainingMs = gameData.timeRemaining;
                const totalTime = 30000; // 30 seconds total
                
                // Update timer every 100ms for smooth animation
                timerInterval = setInterval(() => {
                    remainingMs -= 100;
                    
                    if (remainingMs <= 0) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                        timerCountdown.textContent = '0';
                        timerBar.style.width = '0%';
                        
                        // Force refresh to get timeout result
                        setTimeout(() => loadGame(), 1000);
                        return;
                    }
                    
                    const seconds = Math.ceil(remainingMs / 1000);
                    const percentage = (remainingMs / totalTime) * 100;
                    
                    timerCountdown.textContent = seconds;
                    timerBar.style.width = Math.max(0, percentage) + '%';
                    
                    // Change color scheme as time runs out
                    if (percentage > 60) {
                        timerBar.style.background = '#28a745';
                    } else if (percentage > 30) {
                        timerBar.style.background = 'linear-gradient(90deg, #28a745, #ffc107)';
                    } else {
                        timerBar.style.background = 'linear-gradient(90deg, #ffc107, #dc3545)';
                    }
                }, 100);
            } else {
                timerDisplay.style.display = 'none';
            }
        }

        function updateGameStatus() {
            if (gameData.status === 'completed') {
                showGameResult();
                return;
            }
            
            if (gameData.status === 'queued') {
                showStatusMessage('Waiting for opponent to join the game...', 'waiting');
            } else if (gameData.status === 'in_progress') {
                if (gameData.isYourTurn) {
                    showStatusMessage('Your turn! Click on an empty cell to claim it.', 'success');
                } else {
                    showStatusMessage(`Waiting for ${gameData.currentPlayer}'s move...`, 'waiting');
                }
            }
        }

        function showGameResult() {
            const statusElement = document.getElementById('status-message');
            const currentUser = localStorage.getItem('username');
            
            let resultClass = '';
            let resultText = '';
            
            if (gameData.winner === currentUser) {
                resultClass = 'winner';
                resultText = 'üéâ Victory! You connected your sides and won 19.5 TRX! üéâ';
            } else if (gameData.winner && gameData.winner !== currentUser) {
                resultClass = 'loser';
                resultText = 'üòû Defeat! Your opponent connected their sides first.';
            } else {
                resultClass = 'draw-result';
                resultText = 'üìç Draw! The board filled without a winner. Last player to move loses.';
            }
            
            statusElement.innerHTML = `<div class="game-result ${resultClass}">${resultText}</div>`;
            
            // Stop polling when game is over
            if (gameInterval) {
                clearInterval(gameInterval);
                gameInterval = null;
            }
            
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function showStatusMessage(message, type) {
            const statusElement = document.getElementById('status-message');
            statusElement.textContent = message;
            statusElement.className = `status-message ${type}`;
        }

        async function makeMove(position) {
            if (!gameData.isYourTurn || gameData.status !== 'in_progress') {
                return;
            }
            
            // Check if cell is already claimed
            if (gameData.board && gameData.board[position] !== '') {
                return;
            }
            
            // Provide immediate visual feedback
            const cellElement = document.querySelector(`[data-cell-id="${position}"]`);
            if (cellElement) {
                cellElement.style.opacity = '0.7';
                cellElement.style.pointerEvents = 'none';
            }
            
            try {
                const response = await fetch(`${API_URL}/game/${gameId}/move`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ position })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message);
                }
                
                const data = await response.json();
                
                // Update local game data
                gameData.board = data.board;
                gameData.status = data.status;
                gameData.isYourTurn = data.isYourTurn;
                gameData.moveCount = data.moveCount;
                
                if (data.winner) {
                    if (data.winner === 'draw') {
                        gameData.winner = null; // Handle draw case
                    } else {
                        // Determine winner name based on symbol
                        gameData.winner = data.winner === gameData.yourSymbol ? 
                            localStorage.getItem('username') : 
                            (gameData.yourSymbol === 'X' ? gameData.player2 : gameData.player1);
                    }
                }
                
                // Refresh display immediately
                updateGameDisplay();
                
            } catch (error) {
                console.error('Move error:', error);
                
                // Restore cell appearance on error
                if (cellElement) {
                    cellElement.style.opacity = '';
                    cellElement.style.pointerEvents = '';
                }
                
                showStatusMessage('Failed to make move: ' + error.message, 'error');
                
                // Refresh game state after error
                setTimeout(() => loadGame(), 1000);
            }
        }

        function startGamePolling() {
            // Poll every 3 seconds for game updates (when game is active)
            gameInterval = setInterval(() => {
                if (gameData.status !== 'completed') {
                    loadGame();
                } else {
                    clearInterval(gameInterval);
                    gameInterval = null;
                }
            }, 3000);
        }

        function refreshGame() {
            const button = document.getElementById('refresh-button');
            button.disabled = true;
            button.innerHTML = '<div class="loading"></div>Refreshing...';
            
            loadGame().finally(() => {
                button.disabled = false;
                button.innerHTML = 'Refresh Game';
            });
        }

        function showForfeitConfirm() {
            const shouldForfeit = confirm('Are you sure you want to forfeit? You will lose the game and your 10 TRX stake.');
            if (shouldForfeit) {
                forfeitGame();
            }
        }

        async function forfeitGame() {
            try {
                const response = await fetch(`${API_URL}/game/${gameId}/forfeit`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    showStatusMessage('Game forfeited. Redirecting to dashboard...', 'error');
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 2000);
                } else {
                    throw new Error('Failed to forfeit game');
                }
            } catch (error) {
                console.error('Failed to forfeit game:', error);
                showStatusMessage('Failed to forfeit game. Please try again.', 'error');
            }
        }

        function goToDashboard() {
            if (gameInterval) {
                clearInterval(gameInterval);
                gameInterval = null;
            }
            
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            // Warn user if leaving during active game
            if (gameData.status === 'in_progress') {
                const shouldLeave = confirm('Leaving will forfeit the game and you will lose your 10 TRX stake. Are you sure?');
                if (!shouldLeave) {
                    return;
                }
                
                // Forfeit and then redirect
                forfeitGame().then(() => {
                    window.location.href = 'dashboard.html';
                });
            } else {
                window.location.href = 'dashboard.html';
            }
        }

        // Handle page visibility changes (pause polling when tab is hidden)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                if (gameInterval) {
                    clearInterval(gameInterval);
                    gameInterval = null;
                }
            } else if (gameData.status !== 'completed') {
                // Resume polling when tab becomes visible
                if (!gameInterval) {
                    startGamePolling();
                }
                // Refresh immediately when returning to tab
                loadGame();
            }
        });

        // Handle page close/refresh with forfeit warning
        window.addEventListener('beforeunload', (e) => {
            if (gameData.status === 'in_progress') {
                e.preventDefault();
                e.returnValue = 'Leaving will forfeit the game and you will lose your 10 TRX stake. Are you sure?';
                
                // Send forfeit beacon (best effort)
                if (navigator.sendBeacon) {
                    const formData = new FormData();
                    formData.append('gameId', gameId);
                    navigator.sendBeacon(`${API_URL}/game/${gameId}/forfeit`, formData);
                }
            }
            
            // Cleanup intervals
            if (gameInterval) {
                clearInterval(gameInterval);
                gameInterval = null;
            }
            
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        });

        // Handle connection errors gracefully
        window.addEventListener('online', () => {
            showStatusMessage('Connection restored. Refreshing game...', 'success');
            loadGame();
        });

        window.addEventListener('offline', () => {
            showStatusMessage('Connection lost. Game will resume when online.', 'error');
        });
    </script>
</body>
</html>